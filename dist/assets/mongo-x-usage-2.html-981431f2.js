import{_ as e,W as i,X as o,Y as n,Z as s,$ as t,a0 as p,D as l}from"./framework-f64bc974.js";const u={},c=p(`<h1 id="mongo入门-基本使用-索引和聚合" tabindex="-1"><a class="header-anchor" href="#mongo入门-基本使用-索引和聚合" aria-hidden="true">#</a> Mongo入门 - 基本使用：索引和聚合</h1><blockquote><p>在了解MongoDB的基本CRUD操作后，常用的其它操作还有对字段的索引以及对字段的聚合操作。</p></blockquote><h2 id="_1-聚合-aggregation-pipline" tabindex="-1"><a class="header-anchor" href="#_1-聚合-aggregation-pipline" aria-hidden="true">#</a> 1. 聚合 - Aggregation Pipline</h2><blockquote><p>类似于将SQL中的group by + order by + left join ... 等操作管道化。</p></blockquote><h3 id="_1-1-常规使用" tabindex="-1"><a class="header-anchor" href="#_1-1-常规使用" aria-hidden="true">#</a> 1.1 常规使用</h3><ul><li>图例理解</li></ul><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111222615479.png" alt="image-20230111222615479" tabindex="0" loading="lazy"><figcaption>image-20230111222615479</figcaption></figure><ul><li>准备数据</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> db.orders.insertMany<span class="token punctuation">(</span> <span class="token punctuation">[</span>
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> _id: <span class="token number">1</span>, cust_id: <span class="token string">&quot;abc1&quot;</span>, ord_date: ISODate<span class="token punctuation">(</span><span class="token string">&quot;2012-11-02T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, status: <span class="token string">&quot;A&quot;</span>, amount: <span class="token number">50</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> _id: <span class="token number">2</span>, cust_id: <span class="token string">&quot;xyz1&quot;</span>, ord_date: ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-10-01T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, status: <span class="token string">&quot;A&quot;</span>, amount: <span class="token number">100</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> _id: <span class="token number">3</span>, cust_id: <span class="token string">&quot;xyz1&quot;</span>, ord_date: ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-10-12T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, status: <span class="token string">&quot;D&quot;</span>, amount: <span class="token number">25</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> _id: <span class="token number">4</span>, cust_id: <span class="token string">&quot;xyz1&quot;</span>, ord_date: ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-10-11T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, status: <span class="token string">&quot;D&quot;</span>, amount: <span class="token number">125</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> _id: <span class="token number">5</span>, cust_id: <span class="token string">&quot;abc1&quot;</span>, ord_date: ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-11-12T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, status: <span class="token string">&quot;A&quot;</span>, amount: <span class="token number">25</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>. <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span> <span class="token string">&quot;acknowledged&quot;</span> <span class="token builtin class-name">:</span> true, <span class="token string">&quot;insertedIds&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token number">1</span>, <span class="token number">2</span>, <span class="token number">3</span>, <span class="token number">4</span>, <span class="token number">5</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span> db.orders.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;abc1&quot;</span>, <span class="token string">&quot;ord_date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2012-11-02T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>, <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">50</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>, <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;ord_date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-10-01T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>, <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">100</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>, <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;ord_date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-10-12T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;D&quot;</span>, <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>, <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;ord_date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-10-11T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;D&quot;</span>, <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">125</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>, <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;abc1&quot;</span>, <span class="token string">&quot;ord_date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-11-12T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>, <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>聚合操作</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> db.orders.aggregate<span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">..</span>.                      <span class="token punctuation">{</span> <span class="token variable">$match</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> status: <span class="token string">&quot;A&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.                      <span class="token punctuation">{</span> <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> _id: <span class="token string">&quot;<span class="token variable">$cust_id</span>&quot;</span>, total: <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$amount</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.                      <span class="token punctuation">{</span> <span class="token variable">$sort</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> total: <span class="token parameter variable">-1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.                    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">100</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;abc1&quot;</span>, <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">75</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>官网还有两个例子：</p>`,12),r={href:"https://docs.mongodb.com/v3.6/tutorial/aggregation-zip-code-data-set/",target:"_blank",rel:"noopener noreferrer"},k={href:"https://docs.mongodb.com/v3.6/tutorial/aggregation-with-user-preference-data/",target:"_blank",rel:"noopener noreferrer"},d=p(`<h3 id="_1-2-pipline操作" tabindex="-1"><a class="header-anchor" href="#_1-2-pipline操作" aria-hidden="true">#</a> 1.2 Pipline操作</h3><p>MongoDB的聚合管道（Pipline）将MongoDB文档在一个阶段（Stage）处理完毕后将结果传递给下一个阶段（Stage）处理。<strong>阶段（Stage）操作是可以重复的</strong>。</p><p>表达式：处理输入文档并输出。表达式是无状态的，只能用于计算当前聚合管道的文档，不能处理其它的文档。</p><p>这里我们介绍一下聚合框架中常用的几个Stages：</p><ul><li><code>$project</code>：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li><li><code>$match</code>：用于过滤数据，只输出符合条件的文档。$match使用MongoDB的标准查询操作。</li><li><code>$limit</code>：用来限制MongoDB聚合管道返回的文档数。</li><li><code>$skip</code>：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li><li><code>$unwind</code>：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li><li><code>$group</code>：将集合中的文档分组，可用于统计结果。</li><li><code>$sort</code>：将输入文档排序后输出。</li><li><code>$geoNear</code>：输出接近某一地理位置的有序文档。</li><li><code>$bucket</code>: 分组（分桶）计算。</li><li><code>$facet</code> : 多次分组计算。</li><li><code>$out</code>: 将结果集输出，必须是Pipline最后一个Stage。</li></ul><p>举几个例子</p><ul><li><p>$project</p><p>修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> db.orders.aggregate<span class="token punctuation">(</span>
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> <span class="token variable">$project</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
<span class="token punctuation">..</span>.         _id <span class="token builtin class-name">:</span> <span class="token number">0</span> , // 默认不显示_id
<span class="token punctuation">..</span>.         cust_id <span class="token builtin class-name">:</span> <span class="token number">1</span> ,
<span class="token punctuation">..</span>.         status <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">..</span>.     <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span> <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;abc1&quot;</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;D&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;xyz1&quot;</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;D&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;abc1&quot;</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>$skip</p><p>在聚合管道中跳过指定数量的文档，并返回余下的文档。</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code> db.orders.aggregate<span class="token punctuation">(</span>
<span class="token punctuation">..</span>.     <span class="token punctuation">{</span> <span class="token variable">$skip</span> <span class="token builtin class-name">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>, <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;abc1&quot;</span>, <span class="token string">&quot;ord_date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2013-11-12T17:04:11.102Z&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>, <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>$unwind</p><p>将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> db.inventory2.insertOne<span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;item&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ABC1&quot;</span>, sizes: <span class="token punctuation">[</span> <span class="token string">&quot;S&quot;</span>, <span class="token string">&quot;M&quot;</span>, <span class="token string">&quot;L&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;acknowledged&quot;</span> <span class="token builtin class-name">:</span> true, <span class="token string">&quot;insertedId&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span> db.inventory2.aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token variable">$unwind</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$sizes</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;item&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ABC1&quot;</span>, <span class="token string">&quot;sizes&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;S&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;item&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ABC1&quot;</span>, <span class="token string">&quot;sizes&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;M&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;item&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ABC1&quot;</span>, <span class="token string">&quot;sizes&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;L&quot;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>$bucket</p><p>分组（分桶）计算</p></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> db.artwork.insertMany<span class="token punctuation">(</span><span class="token punctuation">[</span>
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Pillars of Society&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Grosz&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1926</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;199.99&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Melancholy III&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Munch&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1902</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;280.00&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Dancer&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Miro&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1925</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;76.04&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Great Wave off Kanagawa&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Hokusai&quot;</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;167.30&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Persistence of Memory&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Dali&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1931</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;483.00&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Composition VII&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Kandinsky&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1913</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;385.00&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Scream&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Munch&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1893</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>. <span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">8</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Blue Flower&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;O&#39;Keefe&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1918</span>,
<span class="token punctuation">..</span>.     <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;118.42&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>. <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token string">&quot;acknowledged&quot;</span> <span class="token builtin class-name">:</span> true,
        <span class="token string">&quot;insertedIds&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token number">1</span>,
                <span class="token number">2</span>,
                <span class="token number">3</span>,
                <span class="token number">4</span>,
                <span class="token number">5</span>,
                <span class="token number">6</span>,
                <span class="token number">7</span>,
                <span class="token number">8</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token operator">&gt;</span> db.artwork.find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Pillars of Society&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Grosz&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1926</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;199.99&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Melancholy III&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Munch&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1902</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;280.00&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Dancer&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Miro&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1925</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;76.04&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Great Wave off Kanagawa&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Hokusai&quot;</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;167.30&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Persistence of Memory&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Dali&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1931</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;483.00&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">6</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Composition VII&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Kandinsky&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1913</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;385.00&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Scream&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Munch&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1893</span> <span class="token punctuation">}</span> // 注意这里没有price，聚合结果中为Others
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">8</span>, <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Blue Flower&quot;</span>, <span class="token string">&quot;artist&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;O&#39;Keefe&quot;</span>, <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1918</span>, <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;118.42&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token operator">&gt;</span> db.artwork.aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span>
<span class="token punctuation">..</span>.   <span class="token punctuation">{</span>
<span class="token punctuation">..</span>.     <span class="token variable">$bucket</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
<span class="token punctuation">..</span>.       groupBy: <span class="token string">&quot;<span class="token variable">$price</span>&quot;</span>,
<span class="token punctuation">..</span>.       boundaries: <span class="token punctuation">[</span> <span class="token number">0</span>, <span class="token number">200</span>, <span class="token number">400</span> <span class="token punctuation">]</span>,
<span class="token punctuation">..</span>.       default: <span class="token string">&quot;Other&quot;</span>,
<span class="token punctuation">..</span>.       output: <span class="token punctuation">{</span>
<span class="token punctuation">..</span>.         <span class="token string">&quot;count&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.         <span class="token string">&quot;titles&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$push</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$title</span>&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.       <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.     <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.   <span class="token punctuation">}</span>
<span class="token punctuation">..</span>. <span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>, <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>, <span class="token string">&quot;titles&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;The Pillars of Society&quot;</span>, <span class="token string">&quot;Dancer&quot;</span>, <span class="token string">&quot;The Great Wave off Kanagawa&quot;</span>, <span class="token string">&quot;Blue Flower&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">200</span>, <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>, <span class="token string">&quot;titles&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;Melancholy III&quot;</span>, <span class="token string">&quot;Composition VII&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Other&quot;</span>, <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>, <span class="token string">&quot;titles&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;The Persistence of Memory&quot;</span>, <span class="token string">&quot;The Scream&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>$bucket + $facet</p><p>$bucket 分组（分桶）计算</p><p><code>$facet</code> : 多次分组计算。</p></li></ul><blockquote><p>非常常用！</p></blockquote><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>db.artwork.aggregate<span class="token punctuation">(</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token variable">$facet</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;price&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token variable">$bucket</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
              groupBy: <span class="token string">&quot;<span class="token variable">$price</span>&quot;</span>,
              boundaries: <span class="token punctuation">[</span> <span class="token number">0</span>, <span class="token number">200</span>, <span class="token number">400</span> <span class="token punctuation">]</span>,
              default: <span class="token string">&quot;Other&quot;</span>,
              output: <span class="token punctuation">{</span>
                <span class="token string">&quot;count&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>,
                <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$push</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;title&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$title</span>&quot;</span>, <span class="token string">&quot;price&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$price</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>,
      <span class="token string">&quot;year&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token variable">$bucket</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
            groupBy: <span class="token string">&quot;<span class="token variable">$year</span>&quot;</span>,
            boundaries: <span class="token punctuation">[</span> <span class="token number">1890</span>, <span class="token number">1910</span>, <span class="token number">1920</span>, <span class="token number">1940</span> <span class="token punctuation">]</span>,
            default: <span class="token string">&quot;Unknown&quot;</span>,
            output: <span class="token punctuation">{</span>
              <span class="token string">&quot;count&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>,
              <span class="token string">&quot;artwork&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token variable">$push</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;title&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$title</span>&quot;</span>, <span class="token string">&quot;year&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$year</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token punctuation">)</span>

// 输出
<span class="token punctuation">{</span>
  <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1890</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Melancholy III&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1902</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Scream&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1893</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1910</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Composition VII&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1913</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Blue Flower&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1918</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1920</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Pillars of Society&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1926</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Dancer&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1925</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Persistence of Memory&quot;</span>,
          <span class="token string">&quot;year&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1931</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      // Includes the document without a year, e.g., _id: <span class="token number">4</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Unknown&quot;</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Great Wave off Kanagawa&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>,
      <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">4</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Pillars of Society&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;199.99&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Dancer&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;76.04&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Great Wave off Kanagawa&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;167.30&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Blue Flower&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;118.42&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">200</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Melancholy III&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;280.00&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Composition VII&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;385.00&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>,
    <span class="token punctuation">{</span>
      // Includes the document without a price, e.g., _id: <span class="token number">7</span>
      <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;Other&quot;</span>,
      <span class="token string">&quot;count&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
      <span class="token string">&quot;artwork&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Persistence of Memory&quot;</span>,
          <span class="token string">&quot;price&quot;</span> <span class="token builtin class-name">:</span> NumberDecimal<span class="token punctuation">(</span><span class="token string">&quot;483.00&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>,
        <span class="token punctuation">{</span>
          <span class="token string">&quot;title&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;The Scream&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,17),b={href:"https://docs.mongodb.com/v3.6/reference/operator/aggregation-pipeline/",target:"_blank",rel:"noopener noreferrer"},m=n("figure",null,[n("img",{src:"https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111222821329.png",alt:"image-20230111222821329",tabindex:"0",loading:"lazy"}),n("figcaption",null,"image-20230111222821329")],-1),v=n("h3",{id:"_1-3-aggregation-options参数",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1-3-aggregation-options参数","aria-hidden":"true"},"#"),s(" 1.3 Aggregation Options参数")],-1),q={href:"https://docs.mongodb.com/v3.6/reference/method/db.collection.aggregate/",target:"_blank",rel:"noopener noreferrer"},g=p(`<ul><li>explain</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> db.orders.aggregate<span class="token punctuation">(</span>
<span class="token punctuation">..</span>.                      <span class="token punctuation">[</span>
<span class="token punctuation">..</span>.                        <span class="token punctuation">{</span> <span class="token variable">$match</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> status: <span class="token string">&quot;A&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.                        <span class="token punctuation">{</span> <span class="token variable">$group</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> _id: <span class="token string">&quot;<span class="token variable">$cust_id</span>&quot;</span>, total: <span class="token punctuation">{</span> <span class="token variable">$sum</span><span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$amount</span>&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>,
<span class="token punctuation">..</span>.                        <span class="token punctuation">{</span> <span class="token variable">$sort</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span> total: <span class="token parameter variable">-1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.                      <span class="token punctuation">]</span>,
<span class="token punctuation">..</span>.                      <span class="token punctuation">{</span>
<span class="token punctuation">..</span>.                        explain: <span class="token boolean">true</span>
<span class="token punctuation">..</span>.                      <span class="token punctuation">}</span>
<span class="token punctuation">..</span>.                    <span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token string">&quot;serverInfo&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;host&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;pdai&quot;</span>,
                <span class="token string">&quot;port&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">27017</span>,
                <span class="token string">&quot;version&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;3.6.19&quot;</span>,
                <span class="token string">&quot;gitVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;41b289ff734a926e784d6ab42c3129f59f40d5b4&quot;</span>
        <span class="token punctuation">}</span>,
        <span class="token string">&quot;stages&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                        <span class="token string">&quot;<span class="token variable">$cursor</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;query&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                        <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>
                                <span class="token punctuation">}</span>,
                                <span class="token string">&quot;fields&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                        <span class="token string">&quot;amount&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
                                        <span class="token string">&quot;cust_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
                                        <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>
                                <span class="token punctuation">}</span>,
                                <span class="token string">&quot;queryPlanner&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                        <span class="token string">&quot;plannerVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
                                        <span class="token string">&quot;namespace&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;testdb.orders&quot;</span>,
                                        <span class="token string">&quot;indexFilterSet&quot;</span> <span class="token builtin class-name">:</span> false,
                                        <span class="token string">&quot;parsedQuery&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                                <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                                        <span class="token string">&quot;<span class="token variable">$eq</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>
                                                <span class="token punctuation">}</span>
                                        <span class="token punctuation">}</span>,
                                        <span class="token string">&quot;winningPlan&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                                <span class="token string">&quot;stage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;COLLSCAN&quot;</span>,
                                                <span class="token string">&quot;filter&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                                        <span class="token string">&quot;status&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                                                <span class="token string">&quot;<span class="token variable">$eq</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;A&quot;</span>
                                                        <span class="token punctuation">}</span>
                                                <span class="token punctuation">}</span>,
                                                <span class="token string">&quot;direction&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;forward&quot;</span>
                                        <span class="token punctuation">}</span>,
                                        <span class="token string">&quot;rejectedPlans&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
                                <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>,
                <span class="token punctuation">{</span>
                        <span class="token string">&quot;<span class="token variable">$group</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$cust_id</span>&quot;</span>,
                                <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                        <span class="token string">&quot;<span class="token variable">$sum</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;<span class="token variable">$amount</span>&quot;</span>
                                <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>,
                <span class="token punctuation">{</span>
                        <span class="token string">&quot;<span class="token variable">$sort</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                <span class="token string">&quot;sortKey&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
                                        <span class="token string">&quot;total&quot;</span> <span class="token builtin class-name">:</span> <span class="token parameter variable">-1</span>
                                <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>,
        <span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-聚合-map-reduce" tabindex="-1"><a class="header-anchor" href="#_2-聚合-map-reduce" aria-hidden="true">#</a> 2. 聚合 - Map Reduce</h2><ul><li>图例理解</li></ul><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111223321165.png" alt="image-20230111223321165" tabindex="0" loading="lazy"><figcaption>image-20230111223321165</figcaption></figure><h3 id="_2-1-官网给了个例子" tabindex="-1"><a class="header-anchor" href="#_2-1-官网给了个例子" aria-hidden="true">#</a> 2.1 官网给了个例子</h3><ul><li>准备数据</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">{</span>
     _id: ObjectId<span class="token punctuation">(</span><span class="token string">&quot;50a8240b927d5d8b5891743c&quot;</span><span class="token punctuation">)</span>,
     cust_id: <span class="token string">&quot;abc123&quot;</span>,
     ord_date: new Date<span class="token punctuation">(</span><span class="token string">&quot;Oct 04, 2012&quot;</span><span class="token punctuation">)</span>,
     status: <span class="token string">&#39;A&#39;</span>,
     price: <span class="token number">25</span>,
     items: <span class="token punctuation">[</span> <span class="token punctuation">{</span> sku: <span class="token string">&quot;mmm&quot;</span>, qty: <span class="token number">5</span>, price: <span class="token number">2.5</span> <span class="token punctuation">}</span>,
              <span class="token punctuation">{</span> sku: <span class="token string">&quot;nnn&quot;</span>, qty: <span class="token number">5</span>, price: <span class="token number">2.5</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>计算每个顾客总花费：</li></ul><p>map</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>var mapFunction1 <span class="token operator">=</span> <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       emit<span class="token punctuation">(</span>this.cust_id, this.price<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>reduce</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>var reduceFunction1 <span class="token operator">=</span> function<span class="token punctuation">(</span>keyCustId, valuesPrices<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                          <span class="token builtin class-name">return</span> Array.sum<span class="token punctuation">(</span>valuesPrices<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>out</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>db.orders.mapReduce<span class="token punctuation">(</span>
                     mapFunction1,
                     reduceFunction1,
                     <span class="token punctuation">{</span> out: <span class="token string">&quot;map_reduce_example&quot;</span> <span class="token punctuation">}</span>
                   <span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>计算每个订单中Items的均价</li></ul><p>map</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>var mapFunction2 <span class="token operator">=</span> <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token keyword">for</span> <span class="token punctuation">(</span>var idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> this.items.length<span class="token punctuation">;</span> idx++<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                           var key <span class="token operator">=</span> this.items<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>.sku<span class="token punctuation">;</span>
                           var value <span class="token operator">=</span> <span class="token punctuation">{</span>
                                         count: <span class="token number">1</span>,
                                         qty: this.items<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>.qty
                                       <span class="token punctuation">}</span><span class="token punctuation">;</span>
                           emit<span class="token punctuation">(</span>key, value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                       <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>reduce</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>var reduceFunction2 <span class="token operator">=</span> function<span class="token punctuation">(</span>keySKU, countObjVals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     reducedVal <span class="token operator">=</span> <span class="token punctuation">{</span> count: <span class="token number">0</span>, qty: <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

                     <span class="token keyword">for</span> <span class="token punctuation">(</span>var idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> countObjVals.length<span class="token punctuation">;</span> idx++<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         reducedVal.count <span class="token operator">+=</span> countObjVals<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>.count<span class="token punctuation">;</span>
                         reducedVal.qty <span class="token operator">+=</span> countObjVals<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>.qty<span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>

                     <span class="token builtin class-name">return</span> reducedVal<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>finalize</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>var finalizeFunction2 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>key, reducedVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                       reducedVal.avg <span class="token operator">=</span> reducedVal.qty/reducedVal.count<span class="token punctuation">;</span>

                       <span class="token builtin class-name">return</span> reducedVal<span class="token punctuation">;</span>

                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-索引" tabindex="-1"><a class="header-anchor" href="#_3-索引" aria-hidden="true">#</a> 3. 索引</h2><p>索引即为提升查询等的效率，默认是对_id进行索引的。</p><h3 id="_3-1-图例理解" tabindex="-1"><a class="header-anchor" href="#_3-1-图例理解" aria-hidden="true">#</a> 3.1 图例理解</h3><p>以对users中score进行索引时查询的效果</p><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111223525442.png" alt="image-20230111223525442" tabindex="0" loading="lazy"><figcaption>image-20230111223525442</figcaption></figure><h3 id="_3-2-索引的类型" tabindex="-1"><a class="header-anchor" href="#_3-2-索引的类型" aria-hidden="true">#</a> 3.2 索引的类型</h3>`,28),h={href:"https://docs.mongodb.com/v3.6/indexes/",target:"_blank",rel:"noopener noreferrer"},_=p(`<ul><li>单一索引</li></ul><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111223740750.png" alt="image-20230111223740750" tabindex="0" loading="lazy"><figcaption>image-20230111223740750</figcaption></figure><ul><li>复合索引</li></ul><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111223801994.png" alt="image-20230111223801994" tabindex="0" loading="lazy"><figcaption>image-20230111223801994</figcaption></figure><ul><li>多键索引</li></ul><figure><img src="https://zszblog.oss-cn-beijing.aliyuncs.com/zszblog/image-20230111223838780.png" alt="image-20230111223838780" tabindex="0" loading="lazy"><figcaption>image-20230111223838780</figcaption></figure><h3 id="_3-3-对索引的操作" tabindex="-1"><a class="header-anchor" href="#_3-3-对索引的操作" aria-hidden="true">#</a> 3.3 对索引的操作</h3><ul><li>查看集合索引</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>db.col.getIndexes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>查看集合索引大小</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>db.col.totalIndexSize<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>删除集合所有索引</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>db.col.dropIndexes<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>删除集合指定索引</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>db.col.dropIndex<span class="token punctuation">(</span><span class="token string">&quot;索引名称&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章" aria-hidden="true">#</a> 参考文章</h2>`,16),f={href:"https://pdai.tech/md/db/nosql-mongo/mongo-x-usage-2.html",target:"_blank",rel:"noopener noreferrer"};function y(x,$){const a=l("ExternalLinkIcon");return i(),o("div",null,[c,n("ul",null,[n("li",null,[n("a",r,[s("Aggregation with the Zip Code Data Set"),t(a)])]),n("li",null,[n("a",k,[s("Aggregation with User Preference Data"),t(a)])])]),d,n("blockquote",null,[n("p",null,[s("聚合操作使用的比较频繁，在实际的工作中可以参考"),n("a",b,[s("官方文档 - Aggregation Pipeline Stages"),t(a)]),s("。")])]),m,v,n("blockquote",null,[n("p",null,[s("举一个explain参数为例，更多的相关Options可以参考官方文档，"),n("a",q,[s("Aggregrate相关配置在新窗口打开"),t(a)])])]),g,n("p",null,[s("对于索引，这里简单介绍下常用的类型，其它类型和例子可以参考"),n("a",h,[s("官网文档 - 索引"),t(a)])]),_,n("p",null,[n("a",f,[s("Mongo入门 - 基本使用：索引和聚合"),t(a)])])])}const D=e(u,[["render",y],["__file","mongo-x-usage-2.html.vue"]]);export{D as default};
